{% extends "admin_home.html" %}
{% block head %}
<meta charset="UTF-8">
<title>Set up labs</title>

<script>
	//Create a class to store the info of each row
	function Row_info(row_name,row_desc,row_order,value_type,value_range,value_candidates) {
		this.row_name = row_name;
	    this.row_desc = row_desc;
	    this.row_order = row_order;
	    this.value_type = value_type;
	    this.value_range = value_range;
	    this.value_candidates = value_candidates;
	    
	} 
	var row_info_arr = [];
	$(document).ready(function(){
		//Add a new row
		$('button[name=add_a_row]').click(function(){
			var row_num = document.getElementsByClassName('row');
		    var new_index_str = (row_num.length+1).toString();
		    console.log(new_index_str)
			$('div[name=form_body]').append('<span class="row" name='+new_index_str+'><h4>Question'+new_index_str+':</h4><label>Name*: </label><input type="text" name="row_name" required/><br><label>Info: </label> <br><textarea class="longInput" cols="30" rows="5" name="row_desc"></textarea><br><label>Value Type*: </label><input type="text" name="value_type" required/><br><label>Value Range: </label><input type="text" name="value_range"/><label>Value Candidates: </label><input type="text" name="value_candidates"/><br><label>Order Number: </label><input type="text" name="row_order" value='+new_index_str+' min="1" step="1"required> <br><br></span>');	
		});
		//Delete an existing row by specifying the question number
		$('button[name=delete_a_row]').click(function(){
			var row_name_deleted = $('input[name=question_num_deleted]').val();
			$('.row[name='+row_name_deleted+']').remove();
		});
		//Submit labinfo
		$('button[name=submit_labinfo]').click(function(){
				// Flag used to check the correctness of the input
				var wrong_input = false;

				//Collect all the input
				var old_lab_id = $('input[name=old_lab_id]').val();
				var lab_name = $('input[name=lab_name]').val();
				var class_name = $('input[name=class_name]').val();
				var prof_name = $('input[name=prof_name]').val();
				var lab_desc = $('textarea[name=lab_desc]').val();
				var row_num = document.getElementsByClassName('row');
				for (var i=0;i<row_num.length;i++){
					var row_name = $($(row_num[i]).find('input[name=row_name]')).val();
					var row_desc = $($(row_num[i]).find('textarea[name=row_desc]')).val();
					var row_order = $($(row_num[i]).find('input[name=row_order]')).val();
					var value_type = $($(row_num[i]).find('input[name=value_type]')).val();
					var value_range = $($(row_num[i]).find('input[name=value_range]')).val();
					var value_candidates = $($(row_num[i]).find('input[name=value_candidates]')).val();
					
					//Check the correctness of the current input(Check_input is in layout.html) 
					if (Check_input(value_type,value_range,value_candidates)){wrong_input=true; break;}

					new_row_info = new Row_info(row_name,row_desc,row_order,value_type,value_range,value_candidates);
					row_info_arr.push(new_row_info);
				}

			if (wrong_input==false){

				//Delete the old lab and save the new lab
				$.ajax({
				  type: 'POST',
				  contentType: 'application/json',
				  dataType: 'json',
				  url: 'http://127.0.0.1:5000/_admin_modify_lab',
				  data: JSON.stringify({'old_lab_id':old_lab_id,'lab_name':lab_name,'class_name':class_name,'prof_name':prof_name,'lab_desc':lab_desc,'row_data':row_info_arr}),
				  success: function(result){
	   					  alert('Change successfully');
	   					},
				  error : function(result){
	   					  alert('Fail to change(lab id must be unique)');
						}
			    });
			    //Redirect to the main page of setup lab and data access
			    window.location.replace('/admin_setup_labs_and_data_access');
			}
		});

	});

</script>

{% endblock %}
{% block content %}

<form id=labinfo_form>
<section id="container">
    <section id="main-content">
    	<div class="col-lg-12">
        <div class="adminlab">
    	<div class="cleanshape">
   	<center>
    <br></br>
   	<h1>edit lab</h1>
   	<hr></hr>
	<div name="form_body">
	    <input type="text" name="old_lab_id" value={{labinfo.lab_id}} class="invisible"><br></br>
		<label>lab</label><br></br>
		<input type="text" name="lab_name" value={{labinfo.lab_name}}><br></br>
		<label>class</label><br></br>
		<input type="text" name="class_name" value="{{labinfo.class_name}}"/><br></br>
		<label>instructor</label><br></br>
		<input type="text" name="prof_name" value="{{labinfo.prof_name}}"/><br></br>
		<label>instructions</label><br></br>
		<textarea name="lab_desc" class="longInput" cols="20" rows="5" >{{labinfo.lab_desc}}</textarea><br></br>
		<hr></hr>
		{% for row in labinfo.rows_info %}
	    <span class="row" name={{loop.index}}>
			<h4>question {{loop.index}}:</h4>
			<label>name</label><br></br>
			<input type="text" name="row_name" value={{row.row_name}} required/><br></br>
			<label>(optional) info</label><br></br>
			<textarea class="longInput" cols="20" rows="5" name="row_desc">{{row.row_desc}}</textarea><br></br>
			<label>value type</label><br></br>
			<input type="text" name="value_type" value={{row.value_type}} required/><br></br>
			<label>value range</label><br></br>
			<input type="text" name="value_range" value={{row.value_range}}><br></br>
			<label>value possibilites</label><br></br>
			<input type="text" name="value_candidates" value={{row.value_candidates}}><br></br>
			<label>order number</label><br></br>
			<input type="text" name="row_order" value={{row.row_order}} min="1" step="1"required> <br><br>
		</span>
		{% endfor %}
	</div>
	<button name="reset_labinfo" type="reset">Reset</button>
	<br></br>
</form>
	<button name="submit_labinfo">Submit</button>
	<br></br>
	<button name="add_a_row">Add a row</button><br></br>
	<button name="delete_a_row">Delete question</button> <input type="number" min="1" step="1" name="question_num_deleted"><br></br>
	<button><a href="/admin_setup_labs_and_data_access">Return</a></button>
	<br></br>

</center>
</div></div></div>
</section></section>
{% endblock %}

